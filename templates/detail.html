<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.product_name }} - WASABI_CHECK</title>
    <style>
        /* (스타일 약간 조정) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { margin-bottom: 20px; } /* 헤더 아래 여백 줄임 */
        .header .back-link { text-decoration: none; color: #007bff; font-weight: 500; display: inline-block; margin-bottom: 15px; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .search-bar button { padding: 0 15px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.95em; }
        hr { border: none; border-top: 1px solid #eee; margin: 24px 0; }

        /* 상품 정보 */
        .product-info { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .product-details { flex-grow: 1; }
        .product-details .product-number { color: #555; font-size: 1.1em; font-weight: 600; margin-bottom: 5px; }
        .product-details h1 { margin: 0 0 5px 0; color: #333; font-size: 1.6em; line-height: 1.3; }
        .product-meta { font-size: 0.9em; color: #777; margin-bottom: 10px; }
        /* 가격 정보 스타일 */
        .product-pricing { font-size: 1em; margin-bottom: 15px; }
        .product-pricing .original-price { text-decoration: line-through; color: #888; margin-right: 8px; }
        .product-pricing .sale-price { font-weight: bold; color: #333; margin-right: 8px; }
        .product-pricing .discount { color: #dc3545; font-weight: bold; }

        .btn-favorite { background-color: #f0f2f5; color: #333; border: 1px solid #ddd; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95em; flex-shrink: 0; height: fit-content; }
        .btn-favorite.favorited { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }

        .product-image { text-align: center; margin-bottom: 24px; }
        .product-image img { width: 100%; height: 400px; object-fit: contain; border: 1px solid #eee; border-radius: 8px; background-color: #fdfdfd; }
        .product-image .error-text { display: none; color: #888; padding: 40px 0; background-color: #f8f9fa; border-radius: 8px; }

        /* 재고 테이블 */
        .stock-section h2 { margin-top: 0; margin-bottom: 16px; }
        .stock-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .stock-table th, .stock-table td { border-bottom: 1px solid #eee; padding: 12px 10px; text-align: left; vertical-align: middle; }
        .stock-table th { background-color: #f8f9fa; color: #555; font-weight: 600; }
        .stock-table th:first-child { border-radius: 6px 0 0 6px; }
        .stock-table th:last-child { border-radius: 0 6px 6px 0; }
        .text-right { text-align: right !important; }
        .stock-control { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .stock-quantity { font-weight: 700; font-size: 1.2em; color: #2d8b57; min-width: 30px; text-align: center; }
        .stock-quantity.zero { color: #dc3545; }
        .button-stack { display: flex; flex-direction: column; gap: 4px; }
        .stock-control button { width: 30px; height: 22px; font-size: 1em; font-weight: bold; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background-color: #fff; color: #333; line-height: 20px; padding: 0; transition: background-color 0.2s; }
        .stock-control button.btn-inc { color: #007bff; border-color: #007bff; }
        .stock-control button.btn-dec { color: #dc3545; border-color: #dc3545; }
        .stock-hq { color: #555; }

        .related-container { max-width: 900px; margin: 20px auto 0 auto; background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .related-container h2 { margin-top: 0; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .related-list { list-style: none; padding: 0; }
        .related-list li { margin-bottom: 10px; }
        .related-list a { display: block; padding: 16px; text-decoration: none; color: #333; border: 1px solid #eee; border-radius: 6px; transition: background-color 0.2s; }
        .related-list .product-name { font-weight: 600; }
        .related-list .product-number { font-size: 0.9em; color: #555; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">

        {# --- 수정된 헤더 영역 --- #}
        <div class="header">
            <a href="{{ url_for('index') }}" class="back-link">&larr; 돌아가기</a>
            {# 검색창 #}
            <div class="search-bar">
                <form action="/" method="GET" style="display: contents;">
                    <input type="text" name="query" placeholder="다른 상품 검색..." value="">
                    <button type="submit">검색</button>
                </form>
            </div>
        </div>
        <hr> {# 구분선 #}

        {# --- 상품 정보 영역 (가격 추가) --- #}
        <div class="product-info">
            <div class="product-details">
                <div class="product-number">{{ product.product_number }}</div>
                <h1>{{ product.product_name }}</h1>
                <div class="product-meta">
                    {% if product.release_year %}{{ product.release_year }}년 {% endif %}
                    {% if product.item_category %}{{ product.item_category }}{% endif %}
                </div>
                {# 가격 정보 (첫 번째 variant 기준) #}
                {% if variants %} {# variants 리스트가 비어있지 않은 경우 #}
                    {% set first_variant = variants[0] %}
                    <div class="product-pricing">
                        {% if first_variant.original_price and first_variant.original_price > 0 %}
                            <span class="original-price">{{ "{:,d}".format(first_variant.original_price) }}</span>
                            <span class="sale-price">{{ "{:,d}".format(first_variant.sale_price) }}</span>
                            <span class="discount">
                                {{ ((1 - (first_variant.sale_price / first_variant.original_price)) * 100) | int }}%
                            </span>
                        {% else %}
                             <span class="sale-price">{{ "{:,d}".format(first_variant.sale_price) }}</span>
                             {# 최초가가 없거나 0이면 할인율 0% #}
                             <span class="discount">0%</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <button id="fav-btn" class="btn-favorite {{ 'favorited' if product.is_favorite == 1 else '' }}" data-product-number="{{ product.product_number }}">
                {% if product.is_favorite == 1 %} ★ 즐겨찾기 해제 {% else %} ☆ 즐겨찾기 추가 {% endif %}
            </button>
        </div>

        {# --- 상품 이미지 --- #}
        <div class="product-image">
            <img src="{{ image_url }}" alt="{{ product.product_name }} 이미지" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <p class="error-text">(이미지를 불러올 수 없습니다.)</p>
        </div>
        <hr> {# 구분선 #}

        {# --- 재고 현황 (가격/할인율 열 삭제) --- #}
        <div class="stock-section">
            <h2>재고 현황</h2>
            <div style="overflow-x: auto;">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>컬러</th>
                            <th>사이즈</th>
                            <th class="text-right">매장재고</th>
                            <th class="text-right">본사재고</th>
                            {# 최초가, 판매가, 할인율 헤더 삭제됨 #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in variants %}
                        <tr>
                            <td>{{ item.color }}</td>
                            <td>{{ item.size }}</td>
                            <td class="text-right">
                                <div class="stock-control">
                                    <span id="stock-{{ item.barcode }}" class="stock-quantity {{ 'zero' if item.store_stock == 0 else '' }}">{{ item.store_stock }}</span>
                                    <div class="button-stack">
                                        <button class="btn-inc" data-barcode="{{ item.barcode }}" data-change="1">+</button>
                                        <button class="btn-dec" data-barcode="{{ item.barcode }}" data-change="-1">-</button>
                                    </div>
                                </div>
                            </td>
                            <td class="text-right stock-hq">{{ item.hq_stock }}</td>
                            {# 최초가, 판매가, 할인율 데이터 삭제됨 #}
                        </tr>
                        {% else %}
                        <tr> <td colspan="4" style="text-align: center; padding: 20px;">이 상품의 재고 정보가 없습니다.</td> </tr> {# colspan 4으로 수정 #}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <hr> {# 구분선 #}

        {# --- 연관 상품 --- #}
        {% if related_products %}
        <div class="related-container">
            <h2>연관 상품</h2>
            <ul class="related-list">
                {% for rel_prod in related_products %} <li> <a href="{{ url_for('product_detail', product_number=rel_prod.product_number) }}"> <div class="product-name">{{ rel_prod.product_name }}</div> <div class="product-number">{{ rel_prod.product_number }}</div> </a> </li> {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
             const table = document.querySelector('.stock-table tbody'); if (table) { table.addEventListener('click', function(e) { const button = e.target.closest('button'); if (button && (button.classList.contains('btn-inc') || button.classList.contains('btn-dec'))) { const barcode = button.dataset.barcode; const change = parseInt(button.dataset.change, 10); const changeText = change === 1 ? "증가" : "감소"; if (confirm(`[${barcode}] 상품의 재고를 1 ${changeText}시키겠습니까?`)) { const allButtonsInStack = button.closest('.button-stack').querySelectorAll('button'); allButtonsInStack.forEach(btn => btn.disabled = true); updateStockOnServer(barcode, change, allButtonsInStack); } } }); }
             const favButton = document.getElementById('fav-btn'); if (favButton) { favButton.addEventListener('click', function(e) { const button = e.target; const productNumber = button.dataset.productNumber; button.disabled = true; toggleFavoriteOnServer(productNumber, button); }); } });
             function updateStockOnServer(barcode, change, buttons) { fetch("{{ url_for('update_stock') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ barcode: barcode, change: change }) }).then(response => response.json()).then(data => { if (data.status === 'success') { const quantitySpan = document.getElementById(`stock-${data.barcode}`); quantitySpan.textContent = data.new_quantity; quantitySpan.classList.toggle('zero', data.new_quantity === 0); } else { alert(`재고 오류: ${data.message}`); } }).catch(error => { console.error('재고 API 오류:', error); alert('서버 통신 오류.'); }).finally(() => { buttons.forEach(btn => btn.disabled = false); }); }
             function toggleFavoriteOnServer(productNumber, button) { fetch("{{ url_for('toggle_favorite') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ product_number: productNumber }) }).then(response => response.json()).then(data => { if (data.status === 'success') { if (data.new_favorite_status === 1) { button.textContent = '★ 즐겨찾기 해제'; button.classList.add('favorited'); } else { button.textContent = '☆ 즐겨찾기 추가'; button.classList.remove('favorited'); } } else { alert(`즐겨찾기 오류: ${data.message}`); } }).catch(error => { console.error('즐겨찾기 API 오류:', error); alert('서버 통신 오류.'); }).finally(() => { button.disabled = false; }); }
    </script>

</body>
</html>